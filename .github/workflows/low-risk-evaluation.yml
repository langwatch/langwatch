name: Low-Risk PR Evaluation

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to evaluate"
        required: true
        type: number

permissions:
  pull-requests: write
  contents: read

jobs:
  evaluate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch PR metadata and diff
        id: pr-data
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ inputs.pr_number }}
        run: |
          gh pr view "$PR_NUMBER" --json title,body --template '{{.title}}' > /tmp/pr_title.txt
          gh pr view "$PR_NUMBER" --json title,body --template '{{.body}}' > /tmp/pr_body.txt
          gh pr diff "$PR_NUMBER" > /tmp/pr_diff.txt

          # Truncate diff to ~100k chars to stay within token limits
          head -c 100000 /tmp/pr_diff.txt > /tmp/pr_diff_truncated.txt

      - name: Evaluate PR with OpenAI
        id: evaluate
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          POLICY=$(cat docs/LOW_RISK_PULL_REQUESTS.md)
          PR_TITLE=$(cat /tmp/pr_title.txt)
          PR_BODY=$(cat /tmp/pr_body.txt)
          PR_DIFF=$(cat /tmp/pr_diff_truncated.txt)

          # Build the JSON payload using jq to handle escaping
          PAYLOAD=$(jq -n \
            --arg policy "$POLICY" \
            --arg title "$PR_TITLE" \
            --arg body "$PR_BODY" \
            --arg diff "$PR_DIFF" \
            '{
              model: "gpt-5-mini",
              temperature: 0,
              response_format: { type: "json_object" },
              messages: [
                {
                  role: "system",
                  content: ("You evaluate pull requests against a low-risk change policy.\n\nHere is the policy:\n\n" + $policy + "\n\nEvaluate the PR and return JSON with exactly these fields:\n- \"qualifies\": boolean (true if the PR meets ALL low-risk criteria)\n- \"reasoning\": string (2-3 sentence explanation of your assessment)\n- \"scope\": string (brief summary of what the PR changes)")
                },
                {
                  role: "user",
                  content: ("PR Title: " + $title + "\n\nPR Description:\n" + $body + "\n\nDiff:\n" + $diff)
                }
              ]
            }')

          RESPONSE=$(curl -s --max-time 60 https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "$PAYLOAD")

          # Extract the assistant's message content
          RESULT=$(echo "$RESPONSE" | jq -r '.choices[0].message.content')

          if [ "$RESULT" = "null" ] || [ -z "$RESULT" ]; then
            echo "OpenAI API error:"
            echo "$RESPONSE" | jq .
            exit 1
          fi

          echo "$RESULT" > /tmp/evaluation.json

          QUALIFIES=$(echo "$RESULT" | jq -r '.qualifies')
          REASONING=$(echo "$RESULT" | jq -r '.reasoning')
          SCOPE=$(echo "$RESULT" | jq -r '.scope')

          echo "qualifies=$QUALIFIES" >> "$GITHUB_OUTPUT"
          echo "scope<<EOF" >> "$GITHUB_OUTPUT"
          echo "$SCOPE" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
          echo "reasoning<<EOF" >> "$GITHUB_OUTPUT"
          echo "$REASONING" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Apply label and comment
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ inputs.pr_number }}
          QUALIFIES: ${{ steps.evaluate.outputs.qualifies }}
          SCOPE: ${{ steps.evaluate.outputs.scope }}
          REASONING: ${{ steps.evaluate.outputs.reasoning }}
        with:
          script: |
            const prNumber = parseInt(process.env.PR_NUMBER, 10);
            const qualifies = process.env.QUALIFIES === 'true';
            const scope = process.env.SCOPE;
            const reasoning = process.env.REASONING;

            if (qualifies) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels: ["low-risk-change"],
              });

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: [
                  "**Automated low-risk assessment**",
                  "",
                  `This PR was evaluated against the repository's [Low-Risk Pull Requests](docs/LOW_RISK_PULL_REQUESTS.md) procedure.`,
                  `- **Scope:** ${scope}`,
                  `- **Exclusions confirmed:** no changes to auth, security settings, database schema, business-critical logic, or external integrations.`,
                  `- **Classification:** \`low-risk-change\` under the documented policy.`,
                  "",
                  `> ${reasoning}`,
                  "",
                  "This classification allows merging without manual review once all required CI checks are passing and branch protection rules are satisfied.",
                ].join("\n"),
              });

              core.info(`PR #${prNumber} labeled as low-risk-change.`);
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: [
                  "**Automated low-risk assessment**",
                  "",
                  `This PR was evaluated against the repository's [Low-Risk Pull Requests](docs/LOW_RISK_PULL_REQUESTS.md) procedure and **does not qualify** as low risk.`,
                  "",
                  `> ${reasoning}`,
                  "",
                  "This PR requires a manual review before merging.",
                ].join("\n"),
              });

              core.info(`PR #${prNumber} does not qualify as low-risk.`);
            }
