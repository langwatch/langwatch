name: sdk-javascript-ci

on:
  push:
    branches:
      - main
  pull_request:
    paths:
      - "typescript-sdk/**"
      - "langwatch/**"  # Trigger when server changes
      - ".github/workflows/sdk-javascript-ci.yml"
      - ".github/workflows/reusable-e2e-infrastructure.yml"
  workflow_dispatch:

jobs:
  # Fast feedback: lint, typecheck, unit tests, build
  ci:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: typescript-sdk
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.12.1

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"
          cache-dependency-path: "typescript-sdk/pnpm-lock.yaml"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install TypeScript Native Preview
        run: pnpm install -D @typescript/native-preview

      - name: Run lint check
        run: pnpm run lint

      - name: Run typecheck
        run: ./node_modules/.bin/tsgo --noEmit --project ./tsconfig.json

      - name: Run tests
        env:
          OPENAI_API_KEY: ${{ secrets.TYPESCRIPT_SDK_OPENAI_API_KEY }}
          LANGWATCH_API_KEY: ${{ secrets.TYPESCRIPT_SDK_LANGWATCH_API_KEY }}
        run: pnpm test

      - name: Build
        run: pnpm run build

  # E2E tests using reusable workflow (isolated infrastructure)
  e2e:
    needs: ci
    uses: ./.github/workflows/reusable-e2e-infrastructure.yml
    with:
      working-directory: 'typescript-sdk'
      setup-command: >
        pnpm install --frozen-lockfile
        pnpm run build
      test-command: 'pnpm test:e2e'
      node-version: '20'
    secrets:
      OPENAI_API_KEY: ${{ secrets.TYPESCRIPT_SDK_OPENAI_API_KEY }}

