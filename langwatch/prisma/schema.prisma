// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider     = "postgresql"
    // NOTE: When using mysql or sqlserver, uncomment the @db.Text annotations in model Account below
    // Further reading:
    // https://next-auth.js.org/adapters/prisma#create-the-prisma-schema
    // https://www.prisma.io/docs/reference/api-reference/prisma-schema-reference#string
    url          = env("DATABASE_URL")
    relationMode = "prisma"
}

// Necessary for Next auth
model Account {
    id                String   @id @default(nanoid())
    userId            String
    type              String
    provider          String
    providerAccountId String
    refresh_token     String?  @db.Text
    access_token      String?  @db.Text
    expires_at        Int?
    ext_expires_in    Int?
    token_type        String?
    scope             String?
    id_token          String?  @db.Text
    session_state     String?
    user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    createdAt         DateTime @default(now())
    updatedAt         DateTime @default(now()) @updatedAt

    @@unique([provider, providerAccountId])
    @@index([userId])
}

model Session {
    id           String   @id @default(nanoid())
    sessionToken String   @unique
    userId       String
    expires      DateTime
    user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
}

model User {
    id                      String                   @id @default(nanoid())
    name                    String?
    email                   String?                  @unique
    emailVerified           DateTime?
    password                String? // for email/password auth without auth0
    image                   String?                  @db.Text
    pendingSsoSetup         Boolean                  @default(false)
    accounts                Account[]
    sessions                Session[]
    teamMemberships         TeamUser[]
    orgMemberships          OrganizationUser[]
    createdAt               DateTime                 @default(now())
    updatedAt               DateTime                 @default(now()) @updatedAt
    lastLoginAt             DateTime?
    Annotation              Annotation[]
    publicShares            PublicShare[]
    Workflow                Workflow[]
    WorkflowVersion         WorkflowVersion[]
    annotationQueues        AnnotationQueueMembers[]
    assignedQueueItems      AnnotationQueueItem[]    @relation("AssignedTo")
    createdQueueItems       AnnotationQueueItem[]    @relation("CreatedBy")
    llmPromptConfigVersions LlmPromptConfigVersion[]
    scenarios               Scenario[]
    inviteRequests          OrganizationInvite[]
    secretsCreated          ProjectSecret[]          @relation("secretCreatedBy")
    secretsUpdated          ProjectSecret[]          @relation("secretUpdatedBy")
}

model VerificationToken {
    identifier String
    token      String   @unique
    expires    DateTime

    @@unique([identifier, token])
}

enum TeamUserRole {
    ADMIN
    MEMBER
    VIEWER
    CUSTOM
}

enum OrganizationUserRole {
    ADMIN
    MEMBER
    EXTERNAL
}

model TeamUser {
    userId         String
    teamId         String
    role           TeamUserRole
    assignedRoleId String?
    assignedRole   CustomRole?  @relation(fields: [assignedRoleId], references: [id])
    user           User         @relation(fields: [userId], references: [id])
    team           Team         @relation(fields: [teamId], references: [id])
    createdAt      DateTime     @default(now())
    updatedAt      DateTime     @default(now()) @updatedAt

    @@id([userId, teamId])
    @@index([teamId])
    @@index([userId])
    @@index([assignedRoleId])
}

model OrganizationUser {
    userId         String
    organizationId String
    role           OrganizationUserRole
    user           User                 @relation(fields: [userId], references: [id])
    organization   Organization         @relation(fields: [organizationId], references: [id])
    createdAt      DateTime             @default(now())
    updatedAt      DateTime             @default(now()) @updatedAt

    @@id([userId, organizationId])
    @@index([organizationId])
    @@index([userId])
}

model Team {
    id             String       @id @default(nanoid())
    name           String
    slug           String       @unique
    members        TeamUser[]
    organizationId String
    organization   Organization @relation(fields: [organizationId], references: [id])
    projects       Project[]
    createdAt      DateTime     @default(now())
    updatedAt      DateTime     @default(now()) @updatedAt
    archivedAt     DateTime?

    @@index([organizationId])
}

model Organization {
    id                     String               @id @default(nanoid())
    name                   String
    phoneNumber            String?
    slug                   String               @unique
    members                OrganizationUser[]
    teams                  Team[]
    createdAt              DateTime             @default(now())
    updatedAt              DateTime             @default(now()) @updatedAt
    OrganizationInvite     OrganizationInvite[]
    usageSpendingMaxLimit  Int?
    signupData             Json?
    signedDPA              Boolean              @default(false)
    elasticsearchNodeUrl   String?
    elasticsearchApiKey    String?
    useCustomElasticsearch Boolean              @default(false)
    s3Endpoint             String?
    s3AccessKeyId          String?
    s3SecretAccessKey      String?
    s3Bucket               String?
    useCustomS3            Boolean              @default(false)
    sentPlanLimitAlert     DateTime?
    ssoDomain              String?
    ssoProvider            String?

    promoCode     String?
    features      OrganizationFeature[]
    CustomRoles   CustomRole[]
    notifications Notification[]

    // License enforcement fields (COSS-0226)
    license                String?   @db.Text
    licenseExpiresAt       DateTime?
    licenseLastValidatedAt DateTime?

    @@index([ssoDomain])
    @@index([ssoProvider])
}

enum PIIRedactionLevel {
    STRICT
    ESSENTIAL
    DISABLED
}

enum ProjectSensitiveDataVisibilityLevel {
    REDACTED_TO_ALL
    VISIBLE_TO_ADMIN
    VISIBLE_TO_ALL
}

model Project {
    id                       String                              @id @default(nanoid())
    name                     String
    slug                     String                              @unique
    apiKey                   String                              @unique
    teamId                   String
    team                     Team                                @relation(fields: [teamId], references: [id])
    language                 String
    framework                String
    firstMessage             Boolean                             @default(false)
    integrated               Boolean                             @default(false)
    createdAt                DateTime                            @default(now())
    updatedAt                DateTime                            @default(now()) @updatedAt
    userLinkTemplate         String?
    checks                   Monitor[]
    costs                    Cost[]
    topics                   Topic[]
    datasets                 Dataset[]
    datasetRecords           DatasetRecord[]
    customGraphs             CustomGraph[]
    dashboards               Dashboard[]
    batchEvaluations         BatchEvaluation[]
    piiRedactionLevel        PIIRedactionLevel                   @default(ESSENTIAL)
    capturedInputVisibility  ProjectSensitiveDataVisibilityLevel @default(VISIBLE_TO_ALL)
    capturedOutputVisibility ProjectSensitiveDataVisibilityLevel @default(VISIBLE_TO_ALL)
    traceSharingEnabled      Boolean                             @default(true)
    triggers                 Trigger[]
    experiments              Experiment[]
    annotations              Annotation[]
    modelProviders           ModelProvider[]
    projectSecrets           ProjectSecret[]
    defaultModel             String?
    topicClusteringModel     String?
    embeddingsModel          String?
    TriggerSent              TriggerSent[]
    annotationScores         AnnotationScore[]
    publicShares             PublicShare[]
    workflows                Workflow[]
    WorkflowVersion          WorkflowVersion[]
    AnnotationQueue          AnnotationQueue[]
    AnnotationQueueItem      AnnotationQueueItem[]
    s3Endpoint               String?
    s3AccessKeyId            String?
    s3SecretAccessKey        String?
    s3Bucket                 String?
    llmPromptConfigs         LlmPromptConfig[]
    analytics                Analytics[]
    archivedAt               DateTime?
    notifications            Notification[]
    agents                   Agent[]
    evaluators               Evaluator[]
    scenarios                Scenario[]
    suiteConfigurations      SimulationSuite[]

    featureEventSourcingTraceIngestion      Boolean @default(false)
    featureEventSourcingSimulationIngestion Boolean @default(false)
    featureEventSourcingEvaluationIngestion Boolean @default(false)

    featureClickHouseDataSourceTraces      Boolean @default(false)
    featureClickHouseDataSourceSimulations Boolean @default(false)
    featureClickHouseDataSourceEvaluations Boolean @default(false)

    @@index([teamId])
}

enum INVITE_STATUS {
    PENDING
    ACCEPTED
    WAITING_APPROVAL
}

model OrganizationInvite {
    id              String               @id @default(nanoid())
    email           String
    inviteCode      String               @unique
    expiration      DateTime?
    status          INVITE_STATUS        @default(PENDING)
    organizationId  String
    organization    Organization         @relation(fields: [organizationId], references: [id])
    teamIds         String
    teamAssignments Json? // Array of {teamId: string, role: TeamUserRole, customRoleId?: string}
    role            OrganizationUserRole
    requestedBy     String?
    requestedByUser User?                @relation(fields: [requestedBy], references: [id])
    createdAt       DateTime             @default(now())
    updatedAt       DateTime             @default(now()) @updatedAt

    @@index([organizationId])
    @@index([requestedBy])
}

enum EvaluationExecutionMode {
    ON_MESSAGE
    AS_GUARDRAIL
    MANUALLY
}

model Monitor {
    id                String                  @id @default(nanoid())
    projectId         String
    project           Project                 @relation(fields: [projectId], references: [id])
    experimentId      String?                 @unique
    experiment        Experiment?             @relation(fields: [experimentId], references: [id], onDelete: Restrict, onUpdate: Restrict)
    evaluatorId       String? // Reference to saved Evaluator (new monitors)
    evaluator         Evaluator?              @relation(fields: [evaluatorId], references: [id])
    checkType         String
    name              String
    slug              String
    executionMode     EvaluationExecutionMode @default(ON_MESSAGE)
    enabled           Boolean                 @default(true)
    preconditions     Json
    parameters        Json // Keep for backward compatibility, new monitors may have empty
    mappings          Json?
    sample            Float                   @default(1.0)
    level             String                  @default("trace") // "trace" or "thread" - evaluation level
    threadIdleTimeout Int? // Seconds to wait after last message before evaluating thread. null = disabled (evaluate on every message)
    createdAt         DateTime                @default(now())
    updatedAt         DateTime                @default(now()) @updatedAt

    @@unique([projectId, slug])
    @@index([projectId])
    @@index([evaluatorId])
}

enum CostType {
    TRACE_CHECK
    GUARDRAIL
    CLUSTERING
    BATCH_EVALUATION
}

enum CostReferenceType {
    CHECK
    TRACE
    PROJECT
    BATCH
}

model Cost {
    id            String            @id @default(nanoid())
    projectId     String
    project       Project           @relation(fields: [projectId], references: [id])
    costType      CostType
    costName      String?
    referenceType CostReferenceType
    referenceId   String
    amount        Float
    currency      String
    createdAt     DateTime          @default(now())
    updatedAt     DateTime          @default(now()) @updatedAt
    extraInfo     Json?

    @@index([referenceType, referenceId])
    @@index([costType])
    @@index([projectId])
}

model Topic {
    id        String  @id @default(nanoid())
    projectId String
    project   Project @relation(fields: [projectId], references: [id])
    name      String
    parentId  String?
    parent    Topic?  @relation("Subtopics", fields: [parentId], references: [id], onDelete: Restrict, onUpdate: Restrict)
    subtopics Topic[] @relation("Subtopics")

    embeddings_model       String
    centroid               Json
    p95Distance            Float
    automaticallyGenerated Boolean @default(true)

    createdAt DateTime @default(now())
    updatedAt DateTime @default(now()) @updatedAt

    @@index([parentId])
    @@index([projectId])
}

model Dataset {
    id               String            @id @default(nanoid())
    projectId        String
    project          Project           @relation(fields: [projectId], references: [id])
    name             String
    slug             String
    columnTypes      Json
    createdAt        DateTime          @default(now())
    updatedAt        DateTime          @default(now()) @updatedAt
    archivedAt       DateTime?
    datasetRecords   DatasetRecord[]
    batchEvaluations BatchEvaluation[]
    mapping          Json?
    useS3            Boolean           @default(false)
    s3RecordCount    Int?

    @@unique([projectId, slug])
}

model DatasetRecord {
    id        String   @id @default(nanoid())
    datasetId String
    dataset   Dataset  @relation(fields: [datasetId], references: [id])
    projectId String
    project   Project  @relation(fields: [projectId], references: [id])
    entry     Json
    createdAt DateTime @default(now())
    updatedAt DateTime @default(now()) @updatedAt

    @@index([datasetId])
    @@index([projectId])
    @@index([createdAt])
}

model Dashboard {
    id        String        @id @default(nanoid())
    projectId String
    project   Project       @relation(fields: [projectId], references: [id])
    name      String
    order     Int           @default(0)
    createdAt DateTime      @default(now())
    updatedAt DateTime      @default(now()) @updatedAt
    graphs    CustomGraph[]

    @@index([projectId])
    @@index([projectId, order])
    @@map("Dashboard")
}

model CustomGraph {
    id        String   @id @default(nanoid())
    projectId String
    project   Project  @relation(fields: [projectId], references: [id])
    name      String
    graph     Json
    filters   Json?
    createdAt DateTime @default(now())
    updatedAt DateTime @default(now()) @updatedAt

    // Report page relationship
    dashboardId String?
    dashboard   Dashboard? @relation(fields: [dashboardId], references: [id], onDelete: Cascade)

    // Grid positioning (2-column grid)
    gridColumn  Int           @default(0)
    gridRow     Int           @default(0)
    colSpan     Int           @default(1)
    rowSpan     Int           @default(1)
    trigger     Trigger?
    TriggerSent TriggerSent[]

    @@index([projectId])
    @@index([dashboardId])
}

model BatchEvaluation {
    id           String     @id @default(nanoid())
    experimentId String
    experiment   Experiment @relation(fields: [experimentId], references: [id])
    projectId    String
    project      Project    @relation(fields: [projectId], references: [id])
    data         Json       @default("{}")
    status       String
    score        Float
    label        String?
    passed       Boolean
    details      String
    cost         Float
    datasetSlug  String
    datasetId    String
    dataset      Dataset    @relation(fields: [datasetId], references: [id])
    evaluation   String
    createdAt    DateTime   @default(now())
    updatedAt    DateTime   @default(now()) @updatedAt

    @@unique([id])
    @@index([projectId])
    @@index([datasetId])
    @@index([experimentId])
}

enum TriggerAction {
    SEND_EMAIL
    ADD_TO_DATASET
    ADD_TO_ANNOTATION_QUEUE
    SEND_SLACK_MESSAGE
}

enum AlertType {
    CRITICAL
    WARNING
    INFO
}

model Trigger {
    id            String        @id @default(nanoid())
    name          String
    projectId     String
    project       Project       @relation(fields: [projectId], references: [id])
    action        TriggerAction
    actionParams  Json
    filters       Json
    lastRunAt     Float         @default(0)
    createdAt     DateTime      @default(now())
    updatedAt     DateTime      @default(now()) @updatedAt
    active        Boolean       @default(true)
    message       String?
    deleted       Boolean       @default(false)
    alertType     AlertType?
    TriggerSent   TriggerSent[]
    customGraphId String?       @unique
    customGraph   CustomGraph?  @relation(fields: [customGraphId], references: [id], onDelete: Cascade)

    @@index([projectId])
}

enum ExperimentType {
    DSPY
    BATCH_EVALUATION
    BATCH_EVALUATION_V2
    EVALUATIONS_V3
}

model Experiment {
    id               String            @id @default(nanoid())
    name             String?
    type             ExperimentType
    slug             String
    projectId        String
    project          Project           @relation(fields: [projectId], references: [id])
    workflowId       String?
    workflow         Workflow?         @relation(fields: [workflowId], references: [id])
    createdAt        DateTime          @default(now())
    updatedAt        DateTime          @default(now()) @updatedAt
    batchEvaluations BatchEvaluation[]
    workbenchState   Json?
    monitor          Monitor?

    @@unique([projectId, slug])
    @@index([projectId])
    @@index([workflowId])
}

model Annotation {
    id             String   @id @default(nanoid())
    projectId      String
    project        Project  @relation(fields: [projectId], references: [id])
    traceId        String
    comment        String?
    isThumbsUp     Boolean?
    userId         String?
    user           User?    @relation(fields: [userId], references: [id])
    createdAt      DateTime @default(now())
    updatedAt      DateTime @default(now()) @updatedAt
    email          String?
    scoreOptions   Json?
    expectedOutput String?

    @@index([projectId])
    @@index([traceId])
    @@index([userId])
    @@index([projectId, traceId])
}

model ModelProvider {
    id                     String   @id @default(nanoid())
    projectId              String
    project                Project  @relation(fields: [projectId], references: [id])
    provider               String
    enabled                Boolean
    customKeys             Json?
    extraHeaders           Json?
    customModels           Json?
    customEmbeddingsModels Json?
    deploymentMapping      Json?
    createdAt              DateTime @default(now())
    updatedAt              DateTime @default(now()) @updatedAt

    @@index([projectId])
}

model ProjectSecret {
    id             String   @id @default(nanoid())
    projectId      String
    project        Project  @relation(fields: [projectId], references: [id])
    name           String
    encryptedValue String
    createdById    String
    createdBy      User     @relation("secretCreatedBy", fields: [createdById], references: [id])
    updatedById    String
    updatedBy      User     @relation("secretUpdatedBy", fields: [updatedById], references: [id])
    createdAt      DateTime @default(now())
    updatedAt      DateTime @default(now()) @updatedAt

    @@unique([projectId, name])
    @@index([projectId])
}

model TriggerSent {
    id            String       @id @default(nanoid())
    triggerId     String
    traceId       String? // Set for trace-based triggers, null for custom graph alerts
    customGraphId String? // Set for custom graph alerts, null for trace-based triggers
    customGraph   CustomGraph? @relation(fields: [customGraphId], references: [id], onDelete: Cascade)
    projectId     String
    project       Project      @relation(fields: [projectId], references: [id])
    trigger       Trigger      @relation(fields: [triggerId], references: [id])
    resolvedAt    DateTime? // For custom graph alerts: null = still firing, set = resolved
    createdAt     DateTime     @default(now())
    updatedAt     DateTime     @default(now()) @updatedAt

    @@unique([triggerId, traceId])
    @@index([triggerId])
    @@index([projectId])
    @@index([customGraphId])
    @@index([resolvedAt])
}

enum AnnotationScoreDataType {
    CATEGORICAL
    BOOLEAN
    LIKERT
    OPTION
    CHECKBOX
}

model AnnotationScore {
    id                    String                   @id @default(nanoid())
    name                  String
    projectId             String
    project               Project                  @relation(fields: [projectId], references: [id])
    createdAt             DateTime                 @default(now())
    updatedAt             DateTime                 @default(now()) @updatedAt
    deletedAt             DateTime?
    description           String?
    active                Boolean                  @default(true)
    dataType              AnnotationScoreDataType?
    options               Json?
    defaultValue          Json?
    global                Boolean                  @default(false)
    AnnotationQueueScores AnnotationQueueScores[]

    @@index([projectId])
}

enum PublicShareResourceTypes {
    TRACE
    THREAD
}

model AnnotationQueue {
    id                    String                   @id @default(nanoid())
    name                  String
    slug                  String
    projectId             String
    description           String?
    project               Project                  @relation(fields: [projectId], references: [id])
    members               AnnotationQueueMembers[]
    createdAt             DateTime                 @default(now())
    updatedAt             DateTime                 @default(now()) @updatedAt
    AnnotationQueueScores AnnotationQueueScores[]
    AnnotationQueueItems  AnnotationQueueItem[]

    @@unique([projectId, slug])
    @@index([projectId])
}

model AnnotationQueueMembers {
    annotationQueueId String
    userId            String
    user              User            @relation(fields: [userId], references: [id])
    annotationQueue   AnnotationQueue @relation(fields: [annotationQueueId], references: [id])

    @@id([annotationQueueId, userId])
    @@index([annotationQueueId])
    @@index([userId])
}

model AnnotationQueueScores {
    annotationQueueId String
    annotationScoreId String
    annotationScore   AnnotationScore @relation(fields: [annotationScoreId], references: [id])
    annotationQueue   AnnotationQueue @relation(fields: [annotationQueueId], references: [id])

    @@id([annotationQueueId, annotationScoreId])
    @@index([annotationQueueId])
    @@index([annotationScoreId])
}

model AnnotationQueueItem {
    id                String           @id @default(nanoid())
    annotationQueueId String?
    annotationQueue   AnnotationQueue? @relation(fields: [annotationQueueId], references: [id])
    userId            String?
    user              User?            @relation("AssignedTo", fields: [userId], references: [id])
    createdAt         DateTime         @default(now())
    updatedAt         DateTime         @default(now()) @updatedAt
    createdByUserId   String?
    createdByUser     User?            @relation("CreatedBy", fields: [createdByUserId], references: [id])
    traceId           String
    projectId         String
    doneAt            DateTime?
    project           Project          @relation(fields: [projectId], references: [id])

    @@unique([traceId, userId, projectId])
    @@unique([traceId, annotationQueueId, projectId])
    @@index([annotationQueueId])
    @@index([userId])
    @@index([projectId])
    @@index([projectId, doneAt])
    @@index([projectId, userId, doneAt])
    @@index([annotationQueueId, doneAt])
}

model PublicShare {
    id           String                   @id @default(nanoid())
    resourceType PublicShareResourceTypes
    resourceId   String
    projectId    String
    project      Project                  @relation(fields: [projectId], references: [id])
    userId       String?
    user         User?                    @relation(fields: [userId], references: [id])

    createdAt DateTime @default(now())
    updatedAt DateTime @default(now()) @updatedAt

    @@unique([projectId, resourceType, resourceId])
    @@index([userId])
}

model CustomLLMModelCost {
    id                 String   @id @default(nanoid())
    projectId          String
    model              String
    regex              String
    inputCostPerToken  Float?
    outputCostPerToken Float?
    createdAt          DateTime @default(now())
    updatedAt          DateTime @default(now()) @updatedAt

    @@index([projectId])
}

model Workflow {
    id                   String            @id @default(nanoid())
    projectId            String
    project              Project           @relation(fields: [projectId], references: [id])
    name                 String
    icon                 String
    description          String
    createdAt            DateTime          @default(now())
    updatedAt            DateTime          @default(now()) @updatedAt
    latestVersionId      String?
    latestVersion        WorkflowVersion?  @relation("LatestVersion", fields: [latestVersionId], references: [id], onDelete: Restrict, onUpdate: Restrict)
    currentVersionId     String?
    currentVersion       WorkflowVersion?  @relation("CurrentVersion", fields: [currentVersionId], references: [id], onDelete: Restrict, onUpdate: Restrict)
    versions             WorkflowVersion[] @relation("Versions")
    publishedId          String?
    publishedById        String?
    publishedBy          User?             @relation(fields: [publishedById], references: [id])
    archivedAt           DateTime?
    experiments          Experiment[]
    isEvaluator          Boolean           @default(false)
    isComponent          Boolean           @default(false)
    copiedFromWorkflowId String?
    copiedFrom           Workflow?         @relation("WorkflowCopies", fields: [copiedFromWorkflowId], references: [id], onDelete: Restrict, onUpdate: Restrict)
    copiedWorkflows      Workflow[]        @relation("WorkflowCopies")
    agents               Agent[]
    evaluators           Evaluator[]

    @@index([projectId])
    @@index([publishedById])
    @@index([latestVersionId])
    @@index([currentVersionId])
    @@index([copiedFromWorkflowId])
}

model WorkflowVersion {
    id                       String            @id @default(nanoid())
    version                  String
    commitMessage            String
    authorId                 String
    author                   User              @relation(fields: [authorId], references: [id])
    projectId                String
    project                  Project           @relation(fields: [projectId], references: [id])
    workflowId               String
    workflow                 Workflow          @relation("Versions", fields: [workflowId], references: [id])
    parentId                 String?
    parent                   WorkflowVersion?  @relation("WorkflowVersionHistory", fields: [parentId], references: [id], onDelete: Restrict, onUpdate: Restrict)
    children                 WorkflowVersion[] @relation("WorkflowVersionHistory")
    autoSaved                Boolean           @default(false)
    createdAt                DateTime          @default(now())
    updatedAt                DateTime          @default(now()) @updatedAt
    dsl                      Json
    WorkflowAsLatestVersion  Workflow[]        @relation("LatestVersion")
    WorkflowAsCurrentVersion Workflow[]        @relation("CurrentVersion")

    @@unique([workflowId, version])
    @@index([workflowId])
    @@index([projectId])
    @@index([parentId])
    @@index([authorId])
    @@index([createdAt])
}

model OrganizationFeature {
    id             String       @id @default(nanoid())
    feature        String
    organizationId String
    organization   Organization @relation(fields: [organizationId], references: [id])
    createdAt      DateTime     @default(now())
    updatedAt      DateTime     @default(now()) @updatedAt
    trialEndDate   DateTime?

    @@unique([feature, organizationId])
    @@index([feature])
    @@index([organizationId])
}

model AuditLog {
    id             String   @id @default(cuid())
    createdAt      DateTime @default(now())
    userId         String
    projectId      String?
    organizationId String?
    action         String
    args           Json?
    error          String?
    ipAddress      String?
    userAgent      String?
    metadata       Json?

    @@index([createdAt])
    @@index([userId])
    @@index([projectId])
    @@index([organizationId])
    @@index([action])
    @@index([ipAddress])
}

enum PromptScope {
    ORGANIZATION
    PROJECT
}

model LlmPromptConfig {
    id             String      @id @default(nanoid())
    handle         String? // Globally unique identifier in format team/sample-prompt
    name           String
    projectId      String
    project        Project     @relation(fields: [projectId], references: [id])
    createdAt      DateTime    @default(now())
    updatedAt      DateTime    @default(now()) @updatedAt
    deletedAt      DateTime?
    organizationId String
    scope          PromptScope @default(PROJECT)

    // Copy tracking
    copiedFromPromptId String?
    copiedFrom         LlmPromptConfig?  @relation("PromptCopies", fields: [copiedFromPromptId], references: [id], onDelete: Restrict, onUpdate: Restrict)
    copiedPrompts      LlmPromptConfig[] @relation("PromptCopies")

    // Relation to all versions - latest is determined by query
    versions LlmPromptConfigVersion[] @relation("Versions")

    @@unique([handle], map: "LlmPromptConfig_handle_key")
    @@index([projectId])
    @@index([organizationId], map: "LlmPromptConfig_organizationId_idx")
    @@index([copiedFromPromptId])
}

model LlmPromptConfigVersion {
    id            String          @id @default(nanoid())
    version       Int // The version number of the config
    commitMessage String? // Optional: Describe changes in this version
    authorId      String? // Optional: User who created this version
    author        User?           @relation(fields: [authorId], references: [id])
    configId      String // Foreign key to the parent LlmPromptConfig
    config        LlmPromptConfig @relation("Versions", fields: [configId], references: [id], onDelete: Cascade) // Cascade delete versions if parent is deleted

    // Version specific data
    configData    Json   @map("config") // The actual config JSON for this version
    schemaVersion String // Schema version for this specific configData

    createdAt DateTime @default(now()) // Used to determine the latest version

    // Required for multi-tenancy
    projectId String

    @@unique([configId, version]) // Each version number must be unique per config
    @@index([configId])
    @@index([authorId])
    @@index([createdAt]) // Index important for finding the latest efficiently
}

model Analytics {
    id           String   @id @default(nanoid())
    projectId    String
    project      Project  @relation(fields: [projectId], references: [id])
    key          String
    value        Json? // For complex/metadata
    numericValue Float? // For metrics that need aggregation
    stringValue  String? // For categorical data
    boolValue    Boolean? // For true/false metrics
    createdAt    DateTime @default(now())

    @@index([createdAt, key, projectId, numericValue])
    @@index([projectId])
}

model CustomRole {
    id             String       @id @default(nanoid())
    organizationId String
    organization   Organization @relation(fields: [organizationId], references: [id])
    name           String
    description    String?
    permissions    Json // Array of Permission strings
    createdAt      DateTime     @default(now())
    updatedAt      DateTime     @default(now()) @updatedAt
    assignedUsers  TeamUser[]

    @@unique([organizationId, name])
    @@index([organizationId])
}

model Notification {
    id String @id @default(nanoid())

    // Optional context - notifications can be at user, organization, or project level
    organizationId String?
    organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
    projectId      String?
    project        Project?      @relation(fields: [projectId], references: [id], onDelete: Cascade)

    // Flexible metadata to store notification-specific data
    // For usage limit: { currentUsage: number, limit: number, percentage: number, threshold: number }
    metadata Json

    // Timestamps
    createdAt DateTime @default(now())
    updatedAt DateTime @default(now()) @updatedAt
    sentAt    DateTime // When email was actually sent

    @@index([organizationId])
    @@index([projectId])
    @@index([createdAt])
    @@index([sentAt])
}

model Agent {
    id                 String    @id @default(nanoid())
    projectId          String
    project            Project   @relation(fields: [projectId], references: [id])
    name               String
    type               String // "signature" | "code" | "workflow"
    config             Json // Node configuration (model, prompt, code, etc.)
    workflowId         String? // For "workflow" type - top level for joins
    workflow           Workflow? @relation(fields: [workflowId], references: [id])
    copiedFromAgentId  String?
    copiedFrom         Agent?    @relation("AgentCopies", fields: [copiedFromAgentId], references: [id], onDelete: Restrict, onUpdate: Restrict)
    copiedAgents       Agent[]   @relation("AgentCopies")
    archivedAt         DateTime?
    createdAt          DateTime  @default(now())
    updatedAt          DateTime  @default(now()) @updatedAt

    @@index([projectId])
    @@index([workflowId])
    @@index([copiedFromAgentId])
}

model Evaluator {
    id                    String     @id @default(nanoid())
    projectId             String
    project               Project    @relation(fields: [projectId], references: [id])
    name                  String
    slug                  String? // Human-readable identifier for guardrails API
    type                  String // "evaluator" (built-in) | "workflow" (custom)
    config                Json // Settings for built-in, or empty for workflow
    workflowId            String? // For "workflow" type - top level for joins
    workflow              Workflow?  @relation(fields: [workflowId], references: [id])
    copiedFromEvaluatorId String?
    copiedFrom            Evaluator? @relation("EvaluatorCopies", fields: [copiedFromEvaluatorId], references: [id], onDelete: Restrict, onUpdate: Restrict)
    copiedEvaluators      Evaluator[] @relation("EvaluatorCopies")
    monitors              Monitor[] // Monitors using this evaluator
    archivedAt            DateTime?
    createdAt             DateTime   @default(now())
    updatedAt             DateTime   @default(now()) @updatedAt

    @@unique([projectId, slug])
    @@index([projectId])
    @@index([workflowId])
    @@index([copiedFromEvaluatorId])
}

model Scenario {
    id              String    @id @default(nanoid())
    projectId       String
    project         Project   @relation(fields: [projectId], references: [id])
    name            String
    situation       String
    criteria        String[]
    labels          String[]
    lastUpdatedById String?
    lastUpdatedBy   User?     @relation(fields: [lastUpdatedById], references: [id])
    archivedAt      DateTime?
    createdAt       DateTime  @default(now())
    updatedAt       DateTime  @default(now()) @updatedAt

    @@index([projectId])
}

model SimulationSuite {
    id          String    @id @default(nanoid())
    projectId   String
    project     Project   @relation(fields: [projectId], references: [id])
    name        String
    slug        String
    description String?
    scenarioIds String[]
    targets     Json      // Array of { type: "prompt" | "http", referenceId: string }
    repeatCount Int       @default(1)
    labels      String[]
    archivedAt  DateTime?
    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @default(now()) @updatedAt

    @@index([projectId])
    @@unique([projectId, slug])
}

model ProjectDailySdkUsage {
    id                 String   @id
    projectId          String
    date               String   // UTC date "YYYY-MM-DD"
    sdkName            String   @default("")
    sdkVersion         String   @default("")
    sdkLanguage        String   @default("")
    count              Int      @default(0)
    lastEventTimestamp BigInt?  // Unix ms from event.timestamp
    updatedAt          DateTime @default(now()) @updatedAt

    @@unique([projectId, date, sdkName, sdkVersion, sdkLanguage])
    @@index([projectId, date])
}

model ProjectDailyBillableEvents {
    id                 String   @id
    projectId          String
    date               String   // UTC date "YYYY-MM-DD"
    count              Int      @default(0)
    lastEventTimestamp BigInt?
    updatedAt          DateTime @default(now()) @updatedAt

    @@unique([projectId, date])
    @@index([projectId, date])
}
