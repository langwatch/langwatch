# E2E test environment â€” extends compose.dev.yml with test-specific overrides
#
# Usage (from agentic-e2e-tests/ directory):
#   docker compose up -d          # Start everything including app
#   pnpm test                     # Run tests against localhost:5570
#   docker compose down           # Stop all services
#
# Shares node_modules and pnpm store volumes with dev for fast startup.
# Uses isolated DB (testdb), isolated ports, and test-specific env vars.

include:
  - path: ../compose.dev.yml

services:
  # Override app: different port, test DB, test env vars
  app:
    ports:
      - "5570:5560"
    environment:
      COREPACK_ENABLE_DOWNLOAD_PROMPT: "0"
      NODE_ENV: development
      DATABASE_URL: postgresql://prisma:prisma@postgres:5432/testdb
      REDIS_URL: redis://redis:6379
      OPENSEARCH_NODE_URL: http://opensearch:9200
      LANGWATCH_NLP_SERVICE: http://langwatch_nlp:5561
      LANGEVALS_ENDPOINT: http://langevals:5562
      NEXTAUTH_SECRET: test-secret-for-e2e
      NEXTAUTH_URL: http://localhost:5570
      SKIP_CLICKHOUSE_MIGRATE: "true"

  # Override postgres: use testdb instead of mydb
  postgres:
    environment:
      POSTGRES_DB: testdb
      POSTGRES_USER: prisma
      POSTGRES_PASSWORD: prisma
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U prisma -d testdb"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Override redis: different host port
  redis:
    ports:
      - "6380:6379"

  # Override opensearch: different host port, enable for e2e
  opensearch:
    ports:
      - "9201:9200"
      - "9601:9600"

  # Enable NLP for e2e
  langwatch_nlp:
    ports:
      - "5563:5561"

  # Enable langevals for e2e
  langevals:
    ports:
      - "5564:5562"
